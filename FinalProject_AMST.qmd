---
title: "Delving into the Determinants of Making it to University in South America"
subtitle: "Data Science for Public Policy"
author: "Asad Azhar, Juan Menendez, Priscila Stisman, Talia Stringfellow"
execute:
  warning: false
format:
  pdf:
    embed-resources: true
---

## Summary

This final project was initially motivated by the question of how race/ethnicity affects university access in South America. In the process, we turned to a general analysis of socioeconomic determinants of going to university. We use exploratory data analysis techniques to enhance our understanding of general socioeconomic indicators in the region, with a particular focus on university/education attainment. We then present a study case for Argentina, where we apply unsupervised and supervised machine learning techniques to answer our research question. In this case, we find that the most relevant variables in determining access to university are age, income, access to a formal job, household, and skin color. We conclude by suggesting future lines of research and a summary of the technical details we learned about the data during the process.

## 1. Background and Literature Review

While the role of systemic racism in hindering higher education access for racial minorities in Latin America remains an ongoing debate, there are concerns that deeply-rooted societal inequalities may be creating significant barriers. Discrimination may have prevented racial minorities from getting university and college degrees across the region for decades. Research has looked at the complex historical, cultural, and economic reasons behind these alleged racial gaps in higher ed access. This brief review examines how systemic racism could lead to issues like unfair admissions policies, lack of financial support, and other obstacles that may block equitable higher education opportunities for Indigenous, Afro-descendant, and underrepresented racial populations.

A study examined disparities in access to higher education in Argentina, finding significant socioeconomic gaps despite high overall participation rates. Students from lower-income backgrounds and first-generation university attendees faced substantial barriers, while those from higher socioeconomic status and with university-educated parents had notably higher access (Adrogué & García de Fanelli, 2021). Socioeconomic status also influenced the choice between university and non-university tertiary education as well as the likelihood of entering the private sector (Adrogué & García de Fanelli, 2021). Similarly, another article examines socioeconomic segregation in Argentine schools using the Dissimilarity Index for 2021, which measures the proportion of low socioeconomic status (SES) students who would need to be relocated for uniform distribution across all schools. At the national level, 41% of low SES students would need to change schools for equal distribution (Vazquez, Nistal, & Sáenz Guillén, 2024). The provinces with the highest segregation indices were the City of Buenos Aires (48%), Santa Fe (44%), Buenos Aires, Mendoza, and Córdoba (43%), while the least segregated were Santa Cruz (26%), Jujuy (30%), and Tierra del Fuego (32%), highlighting varying degrees of socioeconomic segregation in Argentina's education system (Vazquez, Nistal, & Sáenz Guillén, 2024).

A study done by Daniel Mato, a senior investigater at a center for advanced studies showed how  the omission of non-Western knowledge traditions from academic curricula reflects and perpetuates racist exclusions that impede equitable access to higher education for indigenous and Afro-descendant communities in Argentina (Consejo Nacional de Investigaciones Científicas y Técnicas [CONICET], n.d.).

However, this is not to say that ethnic background is the chief reason for barriers in educational attainment. Similar to a lot of other developing / mid-income countries, Argentina also faces issues such as income inequality which hinders opportunities for higher education.According to Argentina's Permanent Household Survey data, while 58% of individuals over 25 years old have completed high school nationally, there are stark socioeconomic inequalities in educational attainment (Argentinos por la Educación, 2022). In the lowest income decile, only 32% have a high school degree, compared to 87% in the highest income decile - a staggering 55 percentage point gap separating the poorest and wealthiest sectors in terms of high school completion rates (Argentinos por la Educación, 2022). These figures highlight the significant disparities in access to and attainment of secondary education based on income levels within Argentine society.

These effects are not just limited to Argentina.A study by Duarte, Bertolini, and Januzzi (2021) investigated the relative roles of race and socioeconomic status in contributing to inequalities in access to higher education in Brazil. Analyzing data from the 2015 National Household Sample Survey, the authors found that both racial and economic factors were significant determinants, with income and wealth being the stronger overall predictors of higher education participation (Duarte, E. C. P., Bertolini, A. M. P., & Januzzi, P. D. M, 2021). However, racial disparities persisted even after controlling for socioeconomic variables, as Black and mixed-race Brazilians had lower rates of university access compared to whites in the same economic classes (Duarte, E. C. P., Bertolini, A. M. P., & Januzzi, P. D. M, 2021). While racial gaps were smaller at the lowest income levels, they became more pronounced among higher socioeconomic groups (Duarte, E. C. P., Bertolini, A. M. P., & Januzzi, P. D. M, 2021). The intersectional combination of being non-white and low-income created compounded, substantial barriers to higher education attainment (Duarte, E. C. P., Bertolini, A. M. P., & Januzzi, P. D. M, 2021). 

### References

Adrogué, C., & García de Fanelli, A. (2021). Inequality gaps in the access to higher education in Argentina. Páginas de Educación, ISSN: 1688-5287, e-ISSN: 1688-7468. Universidad Católica de Uruguay.

Argentinos por la Educación. (2022). Desigualdad educativa en el nivel superior [Educational inequality at the higher level]. https://argentinosporlaeducacion.org/wp-content/uploads/2022/02/desigualdad-educativa-en-el-nivel-superior.pdf

Consejo Nacional de Investigaciones Científicas y Técnicas. (n.d.). Towards the eradication of racism and discrimination in higher education. Retrieved May 12, 2024, from https://www.conicet.gov.ar/hacia-la-erradicacion-del-racismo-y-la-discriminacion-en-la-educacion-superior/?en

Duarte, E. C. P., Bertolini, A. M. P., & Januzzi, P. D. M. (2021). Color or Money: Racial and Socioeconomic Inequalities in Access to Higher Education in Brazil. Population Review, 60(1). https://doi.org/10.1353/prv.2021.0002


## 2. Data Sources

### **⁠Americas Barometer** - LAPOP/ Vanderbilt University

The Americas Barometer is a periodic survey study of 34 countries in the Western Hemisphere, with stratified nationally representative samples drawn in each country, a common questionnaire core, and country-specific modules. It is the only scientifically rigorous comparative survey of democratic values and behaviors that covers all independent countries in North, Central, and South America, as well as a significant number of countries in the Caribbean. The Americas Barometer measures attitudes, evaluations, experiences, and behavior in the Americas using national probability samples of voting-age adults. This dataset contains all our variables of interest

This LAPOP dataset is unique in that it captures ethnicity beyond just a categorized box checking system often normalized in demographic research. Indeed, researchers also asked the survey participants to self-identify skin tone coloring on a scale of 1-11 (lightest to darkest) and subsequently had the surveyor themselves categorize the participant. This allows for a more nuanced investigation of how perceived racial differences have influence on individuals life outcomes. 

The AmericasBarometer by the LAPOP Lab, www.vanderbilt.edu/lapop

### **Rgeoboundaries** - Runfola et al, 2020

For the geospatial analysis, we use data from rgeoboundaries. It contains political administrative boundaries for the globe as they were by 2020. Since South America has not experienced boundaries changes in 21st century, we use the dataset as it is, just adjusting the scope to the subcontinent.

Runfola D, Anderson A, Baier H, Crittenden M, Dowker E, Fuhrig S, et al. (2020) geoBoundaries: A global database of political administrative boundaries. PLoS ONE 15(4): e0231866. https://doi.org/10.1371/journal.pone.0231866

## 3. Data Wrangling

**Libraries**

```{r}
library(tidyverse)
library(tidymodels)
library(recipes)
library(ggplot2)
library(ggrepel)
library(patchwork)
library(tidyclust)
library(dplyr)
library(themis)
library(haven)
library(rpart)
library(lubridate)
library(archive)
library(utils)
library(tigris)
library(sf)
library(geodata)
library(rnaturalearth)
library(mapview)
library(textrecipes) 
library(vip)
library(here)
library(glmnet)
library(ranger)
library(rsample)
library(parsnip)
library(workflows)
library(tune)
library(yardstick)
library(rgeoboundaries)
library(readxl)
library(scales)
library(geobr)
library(spData)
library(colorspace)
library(missRanger)
library(vip)
library(ggfortify) 
library(FactoMineR) 
```

**Read in Data**

```{r}
lat_am_pop_2023 <- read_dta("Merge_2023_LAPOP_AmericasBarometer_v1.0_w.dta")

Workingdata <- lat_am_pop_2023 %>% select(colorr, colori, etid, ocup4a, formal, cp13, cp8, r4a, smedia1n, q1tc_r, q2, q12cn, q10inc, edre, pais, ur, q14motan, prov)
```

**Data wrangling**

In this section, we identify and clean our variables of interest, which can be grouped as it follows:

[**1) Etnicity/ skin color identification**]{.underline}

Colorr: contains individual skintone on a scale form 0 to 11 (categorical)

Colori: interviewer skincolor

Etid: self perceived ethnicity (categorical)

[**2) Employment Status**]{.underline}

Ocup4a: employment status (dummy)

formal: formal job (dummy)

[**3) Social Capital**]{.underline}

cp13: political party meetings attendance (frequency of attendance, categorical)

cp8: community meetings attendance (frequency of attendance, categorical)

r4a: has a mobile phone (dummy)

smedia1n: has social media (dummy)

[**4) Demographic Data**]{.underline}

q1tc_r: sex (make dummy)

q2: age (continuous)

q12cn: number of members in the household

q10inc: income (Argentine pesos, categorical) (for Argentina)

Edre: education attainment (all levels)

pais : country (numeric)

```{r}
#creating dummy for work status where 1 is working and zero is not working 
Workingdata <- Workingdata %>%
  mutate(ocup4a = case_when(
    ocup4a == 1 ~ 1,
    ocup4a == 2 ~ 0,
    ocup4a == 3 ~ 0,
    ocup4a == 4 ~ 0,
    ocup4a == 5 ~ 0,
    ocup4a == 6 ~ 0,
    ocup4a == 7 ~ 0,
  ))

#cleaning skin color (self identified) 
Workingdata <- Workingdata %>%
  mutate(colorr = case_when(
    colorr == 1 ~ 1,
    colorr == 2 ~ 2,
    colorr == 3 ~ 3,
    colorr == 4 ~ 4,
    colorr == 5 ~ 5,
    colorr == 6 ~ 6,
    colorr == 7 ~ 7, 
    colorr == 8 ~ 8,
    colorr == 9 ~ 9,
    colorr == 10 ~ 10,
    colorr == 11 ~ 11, 
    colorr == 97 ~ NA, 
    TRUE ~ NA
  ))


#cleaning formal vs informal work 
Workingdata <- Workingdata %>%
  mutate(formal = case_when(
    formal == 1 ~ 1,
    formal == 2 ~ 0
  ))

#cleaning uses social media indicator variable
Workingdata <- Workingdata %>%
  mutate(smedia1n = case_when(
    smedia1n == 1 ~ 1,
    smedia1n == 2 ~ 0
  ))

#cleaning political involvement to be least to most 
Workingdata <- Workingdata %>%
  mutate(cp13 = case_when(
    cp13 == 4 ~ 1,
    cp13 == 3 ~ 2,
    cp13 == 2 ~ 3,
    cp13 == 1 ~ 4,
  ))

#cleaning community involvement to be least to most 
Workingdata <- Workingdata %>%
  mutate(cp8 = case_when(
    cp8 == 4 ~ 1,
    cp8 == 3 ~ 2,
    cp8 == 2 ~ 3,
    cp8 == 1 ~ 4,
  ))

#cleaning urban indicator variable
Workingdata <- Workingdata %>%
  mutate(ur = case_when(
    ur == 1 ~ 1,
    ur == 2 ~ 0
  ))

#making gender indicator variable where 0 = female, 1 = male
Workingdata <- Workingdata %>%
  mutate(q1tc_r = case_when(
    q1tc_r == 1 ~ 1,
    q1tc_r == 2 ~ 0,
    q1tc_r == 3 ~ NA,
  ))

#cleaning ethnicity (note there is no etid6, etid7 is "other" so we will convert all the additional races as "other" for simplicity)
#making black the max instead of mulata

Workingdata <- Workingdata %>%
  mutate(etid = case_when(
    etid == 1 ~ 1, 
    etid == 2 ~ 2, 
    etid == 3 ~ 3, 
    etid == 5 ~ 4, 
    etid == 4 ~ 5, 
    etid > 200 ~ 7,
    etid == 7 ~ 7, 
    TRUE ~ NA
  ))

#creating labels for ethnicity 
ethnicity_labels <- c(
  "White" = 1,
  "Mestizo" = 2,
  "Indigenous" = 3,
   "Mulata" = 4, #note that this was orignially coded as 5 and Black as 4, they have been switched 
   "Black" = 5,
  "Other" = 7
)

#creating ethnicity codes 
ethnicity_codes <- c(1, 2, 3, 4, 5, 7)

#creating skin color palette
skincolor <- c("#fff5f6", "#f5e2dc", "#e9c1b7", "#e7c9a5", "#c0a280", "#9d7c53", "#85674f", "#70503b", "#523c2f", "#422811", "#383127")


#creating skin codes 
skincodes <- c(1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11)

#creating a tibble of the color pallet and skin coding 
skincolorpalette <- tibble(skincodes, skincolor)

# create indicator variable for getting to university (includes partial and completion of university)
Workingdata <- Workingdata %>%
  mutate(university = case_when(
    edre == 6 ~ 1,
    edre == 5 ~ 1,
    !(edre %in% c(5, 6)) ~ 0,
    TRUE ~ NA
  ))

#creating a factor variable for getting into university  
Workingdata <- Workingdata %>%
  mutate(university_factor = factor(case_when(
    edre == 6 ~ "University",
    edre == 5 ~ "University", 
    !(edre %in% c(5, 6)) ~ "Non-University", 
    TRUE ~ NA_character_ 
  )))

#creating labels for education 
educ_labels <- c(
  "None" = 0,
  "Primary School Incomplete" = 1,
  "Primary School Complete" = 2,
  "High-school Incomplete" = 3,
  "High-school Complete" = 4,
  "Tertiary/University Incomplete" = 5,
  "Tertiary/University Complete" = 6
)

#cleaning Income for ARGENTINA ONLY 
arg_income_codes <- c(1701, 1702, 1703, 1704, 1705, 1706, 1707, 1708, 1709, 1710, 1711, 1712, 1713, 1714, 1715)

# Labels for ARGENITNA INCOME 
arg_income_labels <- c("Between $0 and $14.000 pesos", "Between $14.001 and $26.000 pesos", "Between $26.001 and $39.000 pesos",
            "Between $39.001 and $47.000 pesos", "Between $47.001 and $55.000 pesos", "Between $55.001 and $61.000 pesos",
            "Between $61.001 and $68.000 pesos", "Between $68.001 and $81.000 pesos", "Between $81.001 and $88.000 pesos",
            "Between $88.001 and $97.000 pesos", "Between $97.001 and $115.000 pesos", "Between $115.001 and $136.000 pesos",
            "Between $136.001 and $168.000 pesos", "Between $168.001 and $221.000 pesos", "More than $221.000 pesos")

# Assign labels FOR ARGENTINA INCOME 
arg_income_values <- factor(arg_income_codes, levels = arg_income_codes, labels = arg_income_labels)

#creating indicator variable for stating "Lack of educational opportunities" as reason for why they have considered emigrating 
Workingdata <- Workingdata %>%
  mutate(leave4educ = case_when(
    q14motan == 3 ~ 1,
    !(q14motan %in% 3) ~ 0,
    TRUE ~ NA
  ))

#Adding country labels 
Workingdata <- Workingdata %>% 
  filter(pais < 39) %>% #getting rid of US and Canada from dataset 
  mutate(country_name = factor(case_when(
    pais == 1 ~ "Mexico",
    pais == 2 ~ "Guatemala", 
    pais == 3 ~ "El Salvador",
    pais == 4 ~ "Honduras", 
    pais == 5 ~ "Nicaragua",
    pais == 6 ~ "Costa Rica", 
    pais == 7 ~ "Panama",
    pais == 8 ~ "Colombia", 
    pais == 9 ~ "Ecuador",
    pais == 10 ~ "Bolivia", 
    pais == 11 ~ "Peru", 
    pais == 12 ~ "Paraguay",
    pais == 13 ~ "Chile", 
    pais == 14 ~ "Uruguay",
    pais == 15 ~ "Brazil", 
    pais == 16 ~ "Venezuela",
    pais == 17 ~ "Argentina", 
    pais == 21 ~ "Dominican Republic", 
    pais == 22 ~ "Haiti", 
    pais == 23 ~ "Jamaica",
    pais == 24 ~ "Guyana", 
    pais == 25 ~ "Trinidad & Tobago",     
    pais == 26 ~ "Belize",
    pais == 27 ~ "Suriname", 
    pais == 28 ~ "Bahamas", 
    pais == 29 ~ "Barbados",
    pais == 30 ~ "Grenada", 
    pais == 31 ~ "Saint Lucia", 
    pais == 32 ~ "Dominica", 
    pais == 33 ~ "Antigua and Barbuda", 
    pais == 34 ~ "Saint Vincent and the Grenadines", 
    pais == 35 ~ "Saint Kitts and Nevis",
    TRUE ~ NA_character_ 
  ))) %>%
  relocate(country_name, .after = pais) 

Workingdata <- Workingdata %>%
  rename(skin_color = colorr,
         ethnicity = etid,
         employed = ocup4a,
         mobile = r4a, 
         social_media = smedia1n,
         male = q1tc_r,
         age = q2, 
         income = q10inc,
         educ_attainment = edre,
         political_involvement = cp13,
         community_involvement=cp8, 
         country_num = pais,
         household_members = q12cn,
         migrating4educ = q14motan)

SouthAmerica_only <- Workingdata %>% 
  filter(country_name == "Argentina" 
         | country_name == "Uruguay" 
         | country_name == "Chile" 
         | country_name == "Paraguay" 
         | country_name == "Bolivia" 
         | country_name == "Peru" 
         | country_name == "Ecuador" 
         | country_name == "Brazil" 
         | country_name == "Suriname" 
         | country_name == "Guyana" 
         | country_name == "French Guiana"  
         | country_name == "Venezuela" 
         | country_name == "Colombia")

#Coding Argentine regions
Workingdata <- Workingdata %>% 
  filter(country_num == 17) %>% #getting rid of US and Canada from dataset 
  mutate(prov = case_when(
    prov == 1702 ~ 1, #"CABA"
    prov == 1706 ~ 1, #"Buenos Aires"
    prov == 1714 ~ 1, #"Córdoba"
    prov == 1718 ~ 4, #"Corrientes"
    prov == 1722 ~ 4, #"Chaco"
    prov == 1730 ~ 1, #"Entre Ríos"
    prov == 1742 ~ 1, #"La Pampa"
    prov == 1750 ~ 3, #"Mendoza" 
    prov == 1758 ~ 2, #"Neuquén"
    prov == 1762 ~ 2, #"Río Negro" 
    prov == 1766 ~ 5, #"Salta"
    prov == 1770 ~ 3, #"San Juan"
    prov == 1178 ~ 1, #"Santa Fe"
    prov == 1786 ~ 5, #"Santiago del Estero"
    prov == 1790 ~ 5, #"Tucumán"
    TRUE ~ NA 
  ))

#1 = centro, 2 = patagonia, 3 = Cuyo, 4= NEA, 5= NOA
```

**Missing Values Assessment** We use Library missRanger for imputing missing values. The "ranger" package (Wright & Ziegler) is helpful to do fast missing value imputation by chained random forests, see Stekhoven & Buehlmann and Van Buuren & Groothuis-Oudshoorn. Between the iterative model fitting, it offers the option of predictive mean matching. This firstly avoids imputation with values not present in the original data (like a value 0.3334 in a 0-1 coded variable). Secondly, predictive mean matching tries to raise the variance in the resulting conditional distributions to a realistic level. This allows to do multiple imputation when repeating the call to missRanger().

### References 

1. Wright, M. N. & Ziegler, A. (2016). ranger: A Fast Implementation of Random Forests for High Dimensional Data in C++ and R. Journal of Statistical Software, in press. \<arxiv.org/abs/1508.04409\>. 

2. Stekhoven, D.J. and Buehlmann, P. (2012). ’MissForest - nonparametric missing value impu- tation for mixed-type data’, Bioinformatics, 28(1) 2012, 112-118. https://doi.org/10.1093/bioinformatics/btr597. 

3. Van Buuren, S., Groothuis-Oudshoorn, K. (2011). mice: Multivariate Imputation by Chained Equations in R. Journal of Statistical Software, 45(3), 1-67. http://www.jstatsoft.org/v45/i03/

```{r}
missing_values <- sum(is.na(Workingdata))
if (missing_values > 0) {
  cat("There are", missing_values, "missing values in the dataset.\n")
  # Handle missing values here (e.g., imputation or other preprocessing steps)
} else {
  cat("No missing values found in the dataset.\n")
}

#There are 122946 missing values in the dataset

#Imputing missing values with MissRanger
Workingdata <- missRanger(Workingdata, num.trees = 30, num.threads = 2)
summary(Workingdata)

#No Missing values found in the dataset
```

## 4. Exploratory Analysis: higher education in South America

### Geospatial Data Upload and Regional Context Mapping 
```{r}
#using the rnaturalearth package
data("world")

sa_all_mapping <- world %>%
  filter(continent == "South America") 

#need to take out countries that are not in the other datasets: Falkland Islands, Venezuela, Guyana, French Guiana 
sa_mapping <- sa_all_mapping %>%
  filter(name_long != "Falkland Islands" & name_long != "Venezuela" & name_long != "Guyana")

#province level data for each country 
geoboundaries <- gb_adm1() %>%
  filter(shapeGroup %in% c("ARG", "COL", "BRA", "URY", "CHL", "VEN", "PRY", "PER", "ECU", "SUR", "GUY", "GUF", "BOL")) 

#Argentina province level data
arg <- gb_adm1("ARG")

#exploring other geospatial data on south america 
library(remotes)
remotes::install_github("wmgeolab/rgeoboundaries")
library(rgeoboundaries)

#Pulling Argentina specific data 
Argentina <- geoboundaries(
     country = "Argentina",
     adm_lvl = "adm1",
     type = "simplified") 

#mapping South America by population 
pop_geom <- sa_all_mapping %>%
  ggplot() +
  geom_sf(aes(fill=pop/10^6), color = "brown", size = 0.1) +
  ggrepel::geom_label_repel(aes(label = name_long, geometry = geom),
    stat = "sf_coordinates",
    min.segment.length = 0,
    size = 3,
    color = "black") + 
  scale_fill_continuous_sequential(palette= "Heat 2")+
    labs(title = "Population by Country\nin Millions of Inhabitants", fill= "Pop.\n(in millions)")+
  theme_void() +
    theme(legend.title=element_text(size=9), 
          plot.title = element_text(face = "bold", hjust = 0.5),
          plot.title.position = "plot")


#mapping South America by Life Expectancy 
le_geom <- sa_all_mapping %>%
  ggplot()+
  geom_sf(aes(fill = lifeExp), color = "brown", size = 0.1) +
  ggrepel::geom_label_repel(aes(label = round(lifeExp),2, geometry = geom),
    stat = "sf_coordinates",
    min.segment.length = 0,
    size = 3,
    color = "black") + 
  scale_fill_continuous_sequential(palette= "Heat 2")+
  labs(title = "Average Life Expenctancy by Country", fill = "Life Expectancy\n(in years)", caption = ) +
  theme_void() +
    theme(legend.title=element_text(size=9),
          plot.title = element_text(face = "bold", hjust = 0.5),
          plot.text = element_text(face = "bold"),
          plot.title.position = "plot")

#side by side:
pop_geom + le_geom 

```

Here we are conducting some basic analysis of how South America maps given country level statistics in the rnaturalearth and rgeoboundaries packages. We see that Chile stands out with the highest life expectancy and somewhat smaller relative population. Brazil has the largest population by far with over 200 million people and has the median south American life expectancy of 75 years. 

Please note this is not data from the LAPOP survey data, but rather best estimates of the true population size and life expectancy based on census / larger scale data. 

### Exploring the LAPOP dataset - Age breakout 
```{r}
#Investigating age distributions by country visually  
SouthAmerica_only %>%
  ggplot(aes(age, fill = country_name)) +
  geom_bar() +
  facet_wrap(~country_name, scales = "free") +
  labs(fill = "Country Name", title = "Age distribution of Data by Country", x = "Age (years)", y = "Count from Survey", caption = "From Representative sample from LAPOP in 2023") +
  theme_minimal() +
    theme(legend.title=element_text(size=9),
          plot.title = element_text(face = "bold", hjust = 0.5),
          plot.title.position = "plot")
```
Based on this survey data, we observe that most South American countries have relatively young population pyramids, with a demographic dividend estimated break even around 2035. Uruguay stands out as a country with a somewhat evenly distributed age distribution and with the most elderly people surveyed.

```{r}
#seeing how much of our data set has considered emigrating for educational attainment purposes (very low at less than 1%)

SouthAmerica_only %>%
  filter(q14 == 1)%>%
  summarise(mean(leave4educ))

```

Part of the survey was asking respondents "And what is the most important reason why you have thought about emigrating?" with the option of "Lack of educational opportunities". We observe that of the people that responded yes to wanting to emigrate in the next 3 years, only a very small portion (0.4%) of the surveyed population noted it as a cause for emigration. Leading us to believe that lack of educational opportunities within one's home country is not a main driver of educational access.  

### Transforming Ethnicity Results of Survey to Country Level 
```{r}
#creating table that counts the ethnicity breakout by country 
countryxeth_tbl <- SouthAmerica_only %>%
  group_by(country_name, ethnicity) %>%
  count(ethnicity) %>%
  pivot_wider(names_from = ethnicity, values_from = n) %>%
  ungroup()

countrylevel_eth_df <- as.data.frame(countryxeth_tbl)

#replacing missing values with zero
countrylevel_eth_df <- within(countrylevel_eth_df, {
  `2` <- replace(`2`, is.na(`2`), 0)
  `3` <- replace(`3`, is.na(`3`), 0)
  `5` <- replace(`5`, is.na(`5`), 0)
})

#create a total column 
countrylevel_eth_df$total_pop <- rowSums(countrylevel_eth_df[, c('1', '2', '3', '4', '5', '7', 'NA')])

countrylevel_eth_df
```

```{r}
#create a proportions ethnicity df out of the raw data 
eth_proportions_df <- countrylevel_eth_df %>%
  group_by(country_name) %>%
  mutate("1" = `1` / total_pop *100,
         "2"= `2` / total_pop *100,
         "3" = `3` / total_pop *100,
         "4" = `4` / total_pop *100,
         "5"= `5` / total_pop *100,
         "7" = `7` / total_pop *100,
         "NA" = `NA` / total_pop *100) %>%
  ungroup()

eth_proportions_df
#data not showing 3 countries: Venezuela, Guyana, French Guiana

#Pivoting the ethnicity proportions longer so that I can interpret with bargraphs 
eth_prop_df_long <-eth_proportions_df %>%
  select(-total_pop) %>%
  pivot_longer(!country_name, names_to = "ethnicity", values_to = "percent")

#adding ethnicity labels to dataframe 
eth_prop_df_long <- eth_prop_df_long %>%
  mutate(eth_lab = case_when(
    ethnicity == 1 ~ "White",
    ethnicity == 2 ~ "Mestizo",
    ethnicity == 3 ~ "Indigenous",
    ethnicity == 4 ~ "Mulata",
    ethnicity == 5 ~ "Black",
    ethnicity == 7 ~ "Other",
    is.na(ethnicity) ~ "No Data"
  ))

eth_prop_df_long 

#creating a bar graph with the ethnicity proportions 
eth_prop_bargraph <- eth_prop_df_long %>%
  ggplot(aes(x = country_name, y = percent, fill = eth_lab)) +
  geom_bar(position = position_fill(reverse = TRUE), stat = "identity") +
  labs(title = "Ethnicity Category as Proportion by Country", caption = "From Representative sample from LAPOP in 2023", y = "Percent", x = "Country", fill = "Ethnicity") +
  scale_fill_brewer(palette = "BrBG", na.value = "orange")+ 
  theme_minimal() +
  theme(legend.title=element_text(face = "bold"),
        plot.title = element_text(face = "bold", hjust = 0.5),
        plot.caption = element_text(face = "italic", hjust = 0.5),
        plot.title.position = "plot")

#use scales - categorical variable - fill manual and set colors with palette 
#scale_fill_manual (vector with categories, colors with hex codes)

#visualizing stacked bar graph 
eth_prop_bargraph
```
Unsurprisingly, Brazil has the highest demographics of citizens that identify as Black and Mulata. Uruguay has the largest white population with a majority white population. The largest community of those that identify as "other" is found in Suriname, followed by Peru. This is likely due to the well established indigenous communities. Argentina is interesting to investigate further because of the plurality but not majority white population followed closely by the Mestizo population. We are curious if the white and non-white ethncity breakout plays a role in education attainment. 

### Transforming Educational Attainment Results of Survey to Country Level 
```{r}
#creating table that counts the education breakout by country 
countryxeduc_tbl <- SouthAmerica_only %>%
  group_by(country_name, educ_attainment) %>%
  count(educ_attainment) %>%
  pivot_wider(names_from = educ_attainment, values_from = n) %>%
  ungroup()

countryxeduc_tbl

#replacing missing values with zero
countryxeduc_tbl <- within(countryxeduc_tbl, {
  `NA` <- replace(`NA`, is.na(`NA`), 0)
})

#creating a total without NA column
countryxeduc_tbl$total_pop_noNA <- rowSums(countryxeduc_tbl[, c('0', '1', '2', '3', '4', '5', '6')])

#create a total column with NA
countryxeduc_tbl$total_pop_withNA <- rowSums(countryxeduc_tbl[, c('0', '1', '2', '3', '4', '5', '6', 'NA')])

countryxeduc_tbl

#create a proportions ethnicity df out of the raw data 
educ_proportions_df <- countryxeduc_tbl %>%
  group_by(country_name) %>%
  mutate("0" = `0` / total_pop_withNA *100,
         "1" = `1` / total_pop_withNA *100,
         "2"= `2` / total_pop_withNA *100,
         "3" = `3` / total_pop_withNA *100,
         "4" = `4` / total_pop_withNA *100,
         "5"= `5` / total_pop_withNA *100,
         "6" = `6` / total_pop_withNA *100,
         "NA" = `NA` / total_pop_withNA *100) %>%
  ungroup()

educ_proportions_df
#data not showing 3 countries: Venezuela, Guyana, French Guiana

#prepping education proportions df for graphing 
educ_prop_df_long <-educ_proportions_df %>%
  select(-total_pop_noNA, -total_pop_withNA) 

educ_prop_df_long  
#Pivoting the ethnicity proportions longer so that I can interpret with bargraphs 
educ_prop_df_long <-educ_prop_df_long %>%
  pivot_longer(!country_name, names_to = "educ_score", values_to = "percent")

#adding labels for education 
educ_prop_df_long <- educ_prop_df_long %>%
  mutate(educ_lab = case_when(
    educ_score == 0 ~ "None",
    educ_score == 1 ~ "Primary School Incomplete",
    educ_score == 2 ~ "Primary School Complete",
    educ_score == 3 ~ "High-school Incomplete",
    educ_score == 4 ~ "High-school Complete",
    educ_score == 5 ~ "Tertiary/University Incomplete",
    educ_score == 6 ~ "Tertiary/University Complete",
    is.na(educ_score) ~ "No Data"
  ))
  
  
  #educ_lab = factor(educ_lab, levels = c("None", "Primary School Incomplete", "Primary School Complete", "High-school Incomplete", "High-school Complete", "Tertiary/University Incomplete", "Tertiary/University Complete", "No Data")))

educ_prop_df_long 

#creating a bar graph with the ethnicity proportions 
educ_prop_bargraph <- educ_prop_df_long %>%
  ggplot(aes(x = country_name, y= percent, fill = educ_score)) +
  geom_bar(position = position_fill(reverse = TRUE), stat="identity") + 
  labs(title = "Educational Outcome Distribution by Country", caption = "From Representative sample from LAPOP in 2023\n 'Pri Sch' means Primary School, 'HS' stands for High School,\n'Uni' stands for University, 'Inc' & 'Comp' stands for in/complete", 
       fill = "Educ level\n(categorical)", y = "Percent", x = "Country") +
  scale_fill_manual(labels = 
                        c("None", "Pri Sch Inc.", "Pri Sch Comp.", 
                          "HS Inc.", "HS Comp.", 
                          "Uni Inc.", "Uni Comp.", "No Data"), values = c("#C2E6C7", "#9FD99E", "#7BC47F", "#4CAF50", "#388E3C", "#2E7D32", "#1B5E20", "#333333")) +
  theme_minimal() +
  theme(legend.title=element_text(face = "bold"),
        plot.title = element_text(face = "bold", hjust = 0.5),
        plot.caption = element_text(face = "italic", hjust = 0.5),
        plot.title.position = "plot")

#visualizing stacked bar graph
educ_prop_bargraph
```
Peru stands out with the highest proportion of their survey respondents who have completed university, followed closely by Chile. Peru also stands out because they have the most respondents that have graduated from high school or higher. Moreover, Peru, Chile and Uruguay have the least survey respondents with no education at all. This makes us ponder whether there is a cultural or political context for Peru's high levels of proportionate educational attainment or if the survey methodology was such that they did not survey a representative sample in terms of education in Peru. 

Interestingly, Uruguay has the most number of respondents who have not completed high school with approximately 70% of those surveyed. Argentina stands out with almost equal amounts of people with incompete and compete highschool educational attainments. 

```{r}
#finding mean educational outcome by country
countryxeduc_tbl <- countryxeduc_tbl %>%
  group_by(country_name) %>%
  mutate(mean_education = (0*`0` + 1*`1` + 2*`2` + 3*`3`+ 4*`4` + 5*`5` + 6*`6`)/total_pop_noNA) 

#adding mean education outcome to our geospatial data (sa_mapping)
#ONLY RUN THIS CODE ONCE! 
sa_mapping <- sa_mapping %>%
  left_join(countryxeduc_tbl, by = c("name_long" = "country_name")) %>%
  select(-matches("\\d+"), -`NA`)

#renameing total pop because it's the survey population not the real population! 
sa_mapping <- sa_mapping %>%
  rename(survey_total_noNA = total_pop_noNA) %>%
  rename(survey_total_withNA = total_pop_withNA)

#Visualizing the Mean population outcomes 
#mapping South America by mean educational outcome 
educ_geom <-sa_mapping %>%
  ggplot()+
  geom_sf(aes(fill = mean_education), color = "white", size = 0.1) +
   ggrepel::geom_label_repel(aes(label = round((mean_education),2), geometry = geom),
    stat = "sf_coordinates",
    min.segment.length = 0,
    size = 3,
    color = "black") + 
  scale_fill_gradient(name = "Avg. Educ\non scale of \n0 to 6", 
                      low = "#C0D8FD", high = "#0F6CFC") +
  labs(title = "Average Educational Outcome \nin South America", subtitle = "using representative data", caption = "Education is categorized based on an increasing \neducational achievement. Variables are coded as follows:\nNone = 0,\nPrimary School Incomplete = 1\nPrimary School Complete = 2\nHigh-school Incomplete = 3\nHigh-school Complete = 4\nTertiary/University Incomplete = 5\nTertiary/University Complete = 6") +
  theme_void() +
  theme(plot.caption = element_text(face = "italic", hjust = 0, size =7),
        legend.title = element_text(size =9),
        plot.title = element_text(face = "bold", hjust = 0.5),
        plot.subtitle = element_text(face = "italic", hjust = 0.5, size = 8),
        plot.title.position = "plot")


#mapping South America by GDP per Capita 
gdp_geom <- sa_mapping %>%
  ggplot()+
  geom_sf(aes(fill = gdpPercap), color = "white", size = 0.1) +
  scale_fill_gradient(name = "GDP\n(per Capita)", 
                      low = "#C0D8FD", high = "#0F6CFC",
                      labels = scales::dollar)+
  labs(title = "GDP per Capita \nin South America", caption = "Findings from representative\nsurvey data 'LAPOP' 2023") +
  theme_void() +
  theme(legend.title=element_text(size =9),
        plot.title = element_text(face = "bold", hjust = 0.5),
        plot.caption = element_text(face = "italic", hjust = 0.5, size =7),
        plot.title.position = "plot")

#side by side:
educ_geom + gdp_geom 

```
Average education outcome in South America is based on the 7 categories described in the caption of the first map. Here we can see another visual identifying Peru as leaders in average higher educational attainment despite having relatively low GDP/per cap. Argentina finds itself in the relative middle-high range with 3.78 mean education outcome as is visible in the GDP/cap graph.  

```{r}
#creating table that counts education breakout by ethnicity 
educxeth_tbl <- SouthAmerica_only %>%
  group_by(ethnicity, educ_attainment) %>%
  count(educ_attainment) %>%
  pivot_wider(names_from = ethnicity, values_from = n) %>%
  ungroup()

educxeth_tbl

#making data factors:
SouthAmerica_only <- SouthAmerica_only %>%
  mutate_at(vars(-age, -income), as.factor)

```

```{r}
skincolor <- c("#fff5f6", "#f5e2dc", "#e9c1b7", "#e7c9a5", "#c0a280", "#9d7c53", "#85674f", "#70503b", "#523c2f", "#422811", "#383127")
skincodes <- c(1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11)
skincolorpalette <- tibble(skincodes, skincolor)

ggplot(SouthAmerica_only, aes(x = factor(skin_color))) +
  geom_bar(aes(fill = factor(skin_color))) +  # Fill mapped to colorr
  scale_fill_manual(values = skincolor) +
  labs(title = "Self-reported skin color", x = "Skin color (from lighter to darker)", y = "Number of Individuals from the sample", fill="Skin Color", caption = "Findings from representative survey data 'LAPOP' 2023,\nrespondents where asked to self-report their skin color.")+
  theme_minimal() +
  theme(legend.title=element_text(size =9),
        plot.title = element_text(face = "bold", hjust = 0.5),
        plot.caption = element_text(face = "italic", hjust = 0.5, size =7),
        plot.title.position = "plot")

```

## 5. Data Analysis: using machine learning to predict attending to university in Argentina

In this section, we conduct unsupervised and supervised machine learning to understand the determinants of achieving university level in Argentina. We chose Argentina because its higher education system is a *rara avis* in the region: the public university system is tuition free for everyone. Given this feature, we would expect the system to be more progressive than those of other South American countries.

To conduct the following analysis, we selected only socioeconomic variables within our data set, and transformed our indicator variable for having attended university into a factor variable.

### 5.1 Unsupervised Machine Learning

```{r}
Argentinadata <- Workingdata %>% filter(country_num==17) #Choosing Argentina

Argentinadata <- Argentinadata %>%  select(-country_name, -country_num, -university_factor,-migrating4educ)

```

We conduct a cluster analysis searching for patterns within the data. We use a k-means model. The goal of k-means clustering is to partition a dataset into k distinct, non-overlapping clusters. To do so, the algorithm minimize the within-cluster variance, which is the sum of squared distances between each data point and its corresponding cluster centroid. The algorithm aims to find centroids that are centrally located within each cluster and to minimize the distance between data points and their assigned centroids.

Once the algorithm converges, each data point belongs to the cluster with the nearest centroid. The resulting clusters are mutually exclusive and collectively exhaustive, meaning that each data point belongs to exactly one cluster, and all data points are assigned to a cluster.

```{r}
set.seed(20201020)
num_clusters <- 4

# Fit the k-means clustering model
kmeans_model <- kmeans(Argentinadata, centers = num_clusters, nstart = 100)

# Print the kmeans_model object
kmeans_model

# Retrieve cluster centers
cluster_centers <- kmeans_model$centers

# Assign cluster labels to each observation
cluster_labels <- kmeans_model$cluster

# Add cluster labels to the original data
Argentinadata_with_clusters <- cbind(Argentinadata, Cluster = cluster_labels)

tidy(kmeans_model) %>%
  knitr::kable(digits = 2)

# Plot the clusters
plot(Argentinadata_with_clusters[, c("age", "income")], 
     col = cluster_labels, pch = 19, main = "K-means Clustering", 
     xlab = "Age", ylab = "Income")

```

K-means clustered the data into four groups according to their particular characteristics. Age seem to have the most clustering power. The model created four well-defined groups, organized around the means of 21, 33, 49 and 68, respectively. The following table presents the four groups and their means for each variable we use. In the subsequent diagram, we can observe no cluster variation across income categories.

Using our cluster analysis, we now turn to Principal Component Analysis (PCA), a dimensionality reduction technique used to simplify the complexity of high-dimensional data while preserving most of its important structure. PCA identifies the directions (principal components) that capture the maximum variance in the data and projects the data onto these new orthogonal axes, thereby reducing overall data dimensionality.

In this case, PCA built upon the previously conducted k-means, meaning it kept the four clusters. In the following diagram, we can observe the distribution of the clusters along the 2 PCs. It's difficult to distinguish the variables that the PCs are reflecting. However, given that k-means built the clusters around age, we can guess that PC2 is reflecting a mix of age and other variables. The distribution across PC1 is also hard to see, but there is a clear pattern: clusters 1 and 2 are organized around two different lines with negatives slopes, whereas clusters 3 and 4 don't present a well-defined distribution.

```{r}
# Perform PCA analysis
pca_result <- PCA(Argentinadata, graph = FALSE)

# Plot the PCA results
pca_with_clusters <- cbind(as.data.frame(pca_result$ind$coord), Cluster = cluster_labels)

# Plot PCA results with cluster labels
ggplot(pca_with_clusters, aes(x = Dim.1, y = Dim.2, color = factor(Cluster))) +
  geom_point() +
  labs(title = "PCA with K-means Clustering", x = "PC1", y = "PC2", color = "Cluster") +
  theme_minimal()
```

### 5.2 Supervised Machine Learning

In this section we use three different machine learning techniques to predict whether a person will make it to university or not. We then compare them according to the pre-selected error metric and pick the best to test it against our testing dataset. Finally, we conduct a variance importance analysis to unveil the weights of each variable in the prediction decision.

```{r}
Argentinadata <- Workingdata %>% filter(country_num==17) #Choosing Argentina

Argentinadata <- Argentinadata %>% select(skin_color, ethnicity, employed, formal, political_involvement, community_involvement, mobile, social_media, male, age, household_members, income, university_factor)

#Splitting the data
set.seed(20201020)
# create a split object
educ_split <- initial_split(data = Argentinadata, prop = 0.75)
# create the training and testing data
workingdata_train <- training(x = educ_split)
workingdata_test <- testing(x = educ_split)
```

### 5.2.a. Probit Classification model

Building a **probit classification model** with embedded regularization to quantify likelihood of making it to college based on our pre-defined predictors. A probit model for classification, also known as a probit regression model, is a statistical model used to predict the probability that an observation belongs to a particular category or class. It is commonly employed in binary classification tasks, where the outcome variable is binary. In our case, our outcome variable takes on two values: 0 for "non-university", and 1 for "university".

In a probit classification model, the relationship between the predictors (independent variables) and the binary outcome variable is modeled using the cumulative distribution function (CDF) of the standard normal distribution, also known as the probit function. This function transforms a linear combination of the predictor variables into a probability, which represents the probability of the outcome belonging to one of the categories.

```{r}
set.seed(20201020)

# Create a recipe
probit_recipe <- recipe(formula = university_factor ~ ., data = workingdata_train) %>%
    step_normalize(all_numeric_predictors()) %>%
    step_nzv(all_numeric_predictors())
             
# Set Probit Model
probit_model <- logistic_reg() %>%
  set_engine("glm", family = binomial(link = "probit"))

# Probit Workflow and recipe
probit_wf <- workflow() %>%
  add_model(probit_model) %>%
  add_recipe(probit_recipe)

# Set folds for cross-validation
folds <- vfold_cv(data = workingdata_train, v = 10)

# Fitting probit model using v-fold resampling method
probit_fit_rs <- probit_wf %>%
  fit_resamples(
    resamples = folds,
    control = control_resamples(save_pred = TRUE, save_workflow = TRUE),
    metrics = metric_set(accuracy, precision, recall)
  )
```

### 5.2.b. Decision Tree

Building a **decision tree** to quantify likelihood of making it to college based on our pre-defined predictors. A decision tree for classification is a predictive modeling algorithm used for solving classification problems, where the goal is to assign input data points to one of two or more predefined classes or categories.

Decision trees recursively partition the feature space into subsets, making decisions based on the values of input features. For this model, we conducted hyperparameter tuning, creating a combination of different trees with the following features: i) we restricted the minimum number per node to 2, 5, 10, and 15; ii) we restricted the maximum depth of the trees to 3, 4, and 5. Then, the algortihm chooses the "best tree", taking into account the relevant metrics we are interested in, precision (see the Models Performance section for more information on this).

Our best tree has 7 layers and 10 nodes. In a nutshell, our decision tree shows that people with a high probability of going to university share some common features: they have mostly formal jobs, are mostly males, and with incomes higher than \$97,000 monthly pesos. See the following image for a detailed assessment of each node's probabilities.

```{r}
set.seed(20201020)

# Create the recipe object 
tree_recipe <- recipe(formula = university_factor ~ ., data = workingdata_train) %>%
  step_normalize(all_numeric_predictors()) %>%
  step_nzv(all_numeric_predictors()) %>%
  step_impute_median(all_numeric_predictors()) %>%
  step_impute_mode(all_nominal_predictors()) 

# Define the parameter grid
param_grid <- expand.grid(
  min_n = c(2, 5, 10, 15),   
  max_depth = c(3, 5, 7)
)

# Create a cart model object
lapop_tree <- 
  decision_tree() %>%
  set_engine("rpart", model = TRUE) %>%
  set_mode("classification")  

# Create a workflow
tree_wf <- workflow() %>%
  add_recipe(tree_recipe) %>%
  add_model(lapop_tree) 

# Tune the model
tree_tune <- tree_wf %>%
  tune_grid(
    resamples = folds,
    grid = param_grid,
    control = control_grid(verbose = TRUE),
    metrics = metric_set(accuracy, precision, recall)
  )

# Extract the best tuning parameters
best_params <- tree_tune %>%
  select_best(metric = "precision")

# Create a new tree model with the best parameters
best_tree_model <- lapop_tree %>%
  set_engine("rpart", model = TRUE) %>%
  set_mode("classification") %>%
  finalize_model(best_params)

# Fit the tuned model
best_tree_fit <- best_tree_model %>%
  fit(data = workingdata_train, formula = university_factor ~ .)

# create a tree
rpart.plot::rpart.plot(x = best_tree_fit$fit)

```

### 5.2.c. Random Forest Classification model

Building a **random forest** to quantify likelihood of making it to college based on our pre-defined predictors. A random forest for classification is an ensemble learning method used for classification tasks. It builds multiple decision trees during training and outputs the class that is the mode of the classes (classification) or mean prediction (regression) of the individual trees. Each tree in the random forest is trained on a random subset of the training data, and a random subset of features is considered for each split in the tree. This randomness helps to decorrelate the trees and reduce overfitting.

During prediction, each tree in the forest independently predicts the class of the input data, and the final prediction is determined by aggregating the predictions of all the trees. In classification tasks, the class with the most votes among all the trees is assigned as the predicted class.

Random forests are known for their robustness, scalability, and ability to handle high-dimensional data with many features. They are widely used in various domains, including finance, healthcare, and bioinformatics, for tasks such as fraud detection, disease diagnosis, and gene expression analysis.

```{r}
set.seed(20201020)

# Create the recipe object and impute missing values
rf_recipe <- recipe(formula = university_factor ~ ., data = workingdata_train) %>%
  step_normalize(all_numeric_predictors()) %>%
  step_nzv(all_numeric_predictors()) %>%
  step_impute_median(all_numeric_predictors()) %>%
  step_impute_mode(all_nominal_predictors())

# Create a random forest model object
lapop_rf <- 
  rand_forest() %>%
  set_engine("ranger") %>%
  set_mode("classification")

# Create a workflow
rf_wf <- workflow() %>%
  add_recipe(rf_recipe) %>%
  add_model(lapop_rf)

# Fit the model
rf_fit_rs <- rf_wf %>%
  fit_resamples(
    resamples = folds,
    control = control_resamples(save_pred = TRUE, save_workflow = TRUE),
    metrics = metric_set(precision, accuracy, recall)
  )

```

### 5.3 Models' Performance

To evaluate the models' performance, we selected three metrcis:

Precision: is the ratio of correctly predicted positive observations to the total predicted positives. It measures the accuracy of the positive predictions made by the model.

Accuracy: is the ratio of correctly predicted observations to the total observations. It measures the overall correctness of the model's predictions.

Recall (Sensitivity): is the ratio of correctly predicted positive observations to the total actual positives. It measures the ability of the model to find all the relevant cases within the data set.

As in this research exercise we are interested in predicting when our outcome variable (attending to university) takes on a positive value, we believe that precision is the most relevant metric.

```{r}
#Collecting metrics
probit_metrics <- collect_metrics(probit_fit_rs, summarize = FALSE)
tree_metrics <- collect_metrics(tree_tune, summarize = FALSE)
rf_metrics <- collect_metrics(rf_fit_rs, summarize = FALSE)

# Add a column to indicate the model for each metrics dataframe
probit_metrics$model <- "Probit"
tree_metrics$model <- "Decision Tree"
rf_metrics$model <- "Random Forest"

# Combine the model metrics into one data frame
combined_metrics <- bind_rows(probit_metrics, tree_metrics, rf_metrics)

#Evaluate
combined_metrics %>%
  group_by(model, .metric) %>%
  mutate(modelmean = mean(.estimate)) %>%
  ungroup() %>%
  ggplot(aes(x = model, color = .metric)) + 
  geom_jitter(aes(y = .estimate), 
              position = position_dodge(width = 0.5), 
              alpha = 0.65, 
              size = 2) +
  geom_point(aes(y = modelmean), 
             shape = 95, 
             position = position_dodge(width = 0.5), 
             size = 10) +
  labs(x = "Model", 
       y = "Metric", 
       title = "Model performance") +
  theme_minimal()
```

Both Probit and Random Forest models have an average precision performance of around .76, meaning that they accurately predict 76% of total positives observations. In terms of accuracy and recall, the Probit model does slightly better. However, because we are already familiar with Probit models for causal inference, for pedagogical reasons we choose to further investigate and test the Random Forest model.

### 5.4.a Variable importance in the random forest model

Variable importance analysis is a method used to assess the contribution of each input variable (feature) to the model's predictive performance. It helps identify which variables have the most significant impact on the model's ability to make accurate predictions.

In Random Forest models, variable importance is typically calculated based on the decrease in node impurity (e.g., Gini impurity or entropy) when a particular variable is used for splitting the data at each node of the trees in the forest. The importance of each variable is then averaged across all trees in the forest to obtain an overall measure of variable importance.

Variable importance analysis provides valuable insights into the relative importance of different features in the dataset. It can guide feature selection, feature engineering, and model interpretation efforts.

Following some of the intuitions we acquired conducting the K-means and Decision Tree models, the most relevant variables within our Random Forest are age, income, formal job, hosehold members, and skin color. See the following figure for further detail.

```{r}
# Fit the random forest model
library(randomForest)

rf_model <- randomForest(formula = university_factor ~ ., data = workingdata_train, ntree = 500)

# Calculate variable importance
var_importance <- importance(rf_model)

# Plot variable importance
var_importance_plot <- varImpPlot(rf_model, main = "Variable Importance - Random Forest")
print(var_importance_plot)

```

### 5.4.b. Implementation of a Random Forest

```{r}
# Preprocess the test dataset using the recipe
test_processed <- rf_recipe %>%
  prep() %>%
  bake(new_data = workingdata_test)

# Fit the model and select the best tuning configuration
rf_fit_best <- rf_fit_rs %>%
  fit_best()

# Predict using the best model configuration
test_predictions <- rf_fit_best %>%
  predict(new_data = workingdata_test) %>%
  bind_cols(workingdata_test)

# Evaluate the model's performance on the test dataset
test_metrics <- test_predictions %>%
  metrics(truth = university_factor, estimate = .pred_class)

# View the test metrics
print(test_metrics)
```
In this section we test our Random Forest model in our testing data set, to evaluate its prediction power for unknown observations. This step is particularly relevant to assess whether the model suffers from overfitting, meaning it is extermely good with the data it was train on (capturing every nuances), but lacks prediction power when applied to unknown data.

Our model has an accuracy rate of .75, meaning that it accurately predicts 75% of the total observed values (both positives and negatives). This is consistent with the performance statistics we obtained in section 5.3, and indicates the model does not overfit the data.

## 6. Discussion of Results

### 6.1 Interpretation 
First, we want to be clear, the models were not designed to, nor should they be used for predicting educational outcomes based on skin tone. Instead, the models should be analyzed in themselves to see if they pick up self described skin tones as a strong predictor of education outcome. This is why the Variable Importance analysis on the Radom Forest model is so intriguing. Here we see that of all variables, age plays the largest role in determining educational outcome. The data however is only for people 16 years and older, so there may be some larger education policy related reasons for why different generations have different educational outcomes. 

Income, unsurprisingly is second. This is something that has been largely explored and understood internationally as a true relationship. Indeed, the more well off a person is, the easier it is to stay in school or pursue higher education. Though, as we noted earlier - Argentina has free access to higher education. This indicates to us that there may be more going on in terms of how income plays a role. This is where the following variables of importance: formal, household_members, skin_color, and ethnicity come into play. Indeed, the dynamics of what kind of employment you have, how many people live in your home, and your race all play into income. This model tells the story we were expecting which is that ethnicity and skin tone do not necessarily drive the narrative of education outcome but instead are factors that tie other income and lifestyle related metrics together and impact expected educational outcome. 

From a policy perspective, one might expect free university and state required education followed by free university would mean that income would not play a role in expected education attainment. However, this model clearly signals that there is more than just the financial cost of attending school but also the opportunity cost that play a role in education outcome as well as the historical disparities that lead people to the circumstances they are in.

### 6.2 Limitation

One limitation to our research is that our models focus on one country in Latin America: Argentina, thus the external validity or larger applicability of these models will need to be adjusted to account for variations found across neighboring countries. Indeed, accessibility of school, income distributions, ethnicity demographics, and cultural norms very likely will impact the findings of the model by countries. Moreover, the ‘best’ model could also change depending on the country and the corresponding data used, as would be expected. 

### 6.3 Future Reserach Suggestions 

We recommend that future researchers start first by scaling the model to other countries in the region then to all of South America. Of course, this research must be conduct using best practices of modeling including resampling and hyper parameter tuning. It is essential that future researchers standardize income across countries before scaling to the whole continent, and have relatively consistent variability across the indicator variables within the unsupervised learning model. The relative variability among countries could then be observed to see how different demographic characteristics play larger or smaller roles.

Future researchers could also do a regional investigation on how different variables affect regional educational outcomes within a country. To do so, they would need to see the labels associated with each administrative level within the LAPOP database and match it to geospatial data for visualizations. We would also recommend including different variables to see how the model reacts to being fed different demographics. Finally, the weighting of the survey is something to dive deeper into if one wanted to expand on this project. 

